name: Prepare NuGet package
on:
  workflow_call:
    inputs:
      version:
        description: Assembly and package version
        required: true
        type: string
      package-module:
        description: Name of the module
        required: true
        type: string
      namespace:
        description: Name of the module namespace
        required: true
        type: string
    secrets:
      signing-key-value:
        description: Value of the signing key
        required: true
env:
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  Version: ${{ inputs.version }}
jobs:
  pack:
    runs-on: windows-latest # We are using windows instead of ubuntu becaus it provides support for net472 & net48.
    timeout-minutes: 15
    if: ${{ startsWith(inputs.package-module, 'Auto' ) }}
    steps:
      - name: 📥 checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: 🖊️ materialize signing key
        id: signing-key
        uses: ./.github/actions/materialize-signing-key
        with:
          signing-key-value: ${{ secrets.signing-key-value }}
      - name: 💾 cache nuget packages
        uses: actions/cache@v3
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: 📦 pack
        run: dotnet pack ./src/${{ inputs.namespace }}.${{ inputs.package-module }}
        env:
          CI: true
          StrongNameKey: ${{ secrets.signing-key-value }}
          StrongNameKeyPath: ${{ steps.signing-key.outputs.file-path }}
      - name: 🔼 upload packages
        uses: actions/upload-artifact@v3
        with:
          name: packages
          path: |
            ./src/**/*.nupkg
            ./src/**/*.snupkg
