name: Build & test
on:
  workflow_call:
    inputs:
      version:
        description: Assembly and package version
        required: true
        type: string
      package-module:
        description: Name of the module
        required: true
        type: string
      namespace:
        description: Name of the module namespace
        required: true
        type: string
      target-framework:
        description: Compiles for a specific framework
        required: true
        type: string
      configuration:
        description: Name of the configuration
        required: false
        type: string
        default: Release
      skip-target-framework-on-build:
        required: false
        type: boolean
        default: false
      collect-code-coverage:
        required: false
        type: boolean
        default: false
    secrets:
      signing-key-value:
        description: Value of the signing key
        required: true
env:
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  Version: ${{ inputs.version }}
  Configuration: ${{ inputs.configuration }}
jobs:
  build-and-test:
    runs-on: windows-latest # We are using windows instead of ubuntu becaus it provides support for net472 & net48.
    timeout-minutes: 15
    steps:
    - name: 📥 checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: 🖊️ materialize signing key
      id: signing-key
      uses: ./.github/actions/materialize-signing-key
      with:
        signing-key-value: ${{ secrets.signing-key-value }}
    - name: 💾 cache nuget packages
      uses: actions/cache@v3
      with:
        path: ${{ env.NUGET_PACKAGES }}
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    - name: 🏗️ build
      run: dotnet build ./src/${{ inputs.namespace }}.${{ inputs.package-module }}.sln${{ inputs.skip-target-framework-on-build == false && format(' -f {0}', inputs.target-framework) || '' }}
      env:
        CI: true
        StrongNameKey: ${{ secrets.SIGNING_KEY }}
        StrongNameKeyPath: ${{ steps.signing-key.outputs.file-path }}
    - name: 🧪 test ${{ inputs.package-module }} in ${{ inputs.target-framework }}
      if: ${{ inputs.collect-code-coverage != true }}
      run: dotnet test ./src/${{ inputs.namespace }}.${{ inputs.package-module }}.Tests/ --no-build -f ${{ inputs.target-framework }}
    - name: 🧪 test ${{ inputs.package-module }} in ${{ inputs.target-framework }} & collect coverage
      if: ${{ inputs.collect-code-coverage == true }}
      uses: ./.github/actions/test-module
      with:
        codecov-token: ${{ secrets.CODECOV_TOKEN }}
        module-name: ${{ inputs.package-module }}
        module-namespace: ${{ inputs.namespace }}
        target-framework: ${{ inputs.target-framework }}